<div class="add-inspection-container">
    <div class="header">
        <h1>
            <span>üìù</span> {{ isEditMode ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏' : '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏' }}
        </h1>
        <button class="btn btn-close" (click)="onCancel()">
            <span>‚Üê</span> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <h3><span>‚ûï</span> –§–æ—Ä–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>

            <form [formGroup]="inspectionForm" class="inspection-form" (ngSubmit)="onSave()">
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">–°–ú–ü</label>
                        <div class="smp-selection">
                            <input type="hidden" formControlName="smpId">
                            <input #smpInput type="text"
                                   formControlName="smpText"
                                   class="form-control"
                                   placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ò–ù–ù..."
                                   (input)="onSmpInput(smpInput.value)"
                                   autocomplete="off" />
                        </div>
                        <div class="smp-results" *ngIf="smpResults.length">
                            <div class="smp-item" *ngFor="let s of smpResults" (click)="selectSmp(s)">
                                <strong>{{ s.name }}</strong> <span class="muted">({{ s.inn }})</span>
                            </div>
                        </div>
                        <div *ngIf="inspectionForm.get('smpId')?.invalid && inspectionForm.get('smpId')?.touched" class="error-message">
                            –í—ã–±–µ—Ä–∏—Ç–µ –°–ú–ü –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞
                        </div>
                        <div *ngIf="smpLoading" class="loading-small">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –°–ú–ü...</div>
                    </div>

                    <div class="form-group">
                        <label class="required">–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π –æ—Ä–≥–∞–Ω</label>
                        <select formControlName="controllingAuthority"
                                class="form-control"
                                required
                                (focus)="loadControllingAuthorities()">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            <option *ngFor="let a of controllingAuthorities" [value]="a">{{ a }}</option>
                        </select>
                        <div *ngIf="contAuthLoading" class="form-hint">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏—Ö –æ—Ä–≥–∞–Ω–æ–≤...</div>
                        <div *ngIf="contAuthLoadError" class="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏—Ö –æ—Ä–≥–∞–Ω–æ–≤</div>
                        <div *ngIf="inspectionForm.get('controllingAuthority')?.hasError('required') && inspectionForm.get('controllingAuthority')?.touched" class="error-message">
                            –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∏–π –æ—Ä–≥–∞–Ω
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="required">–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                        <div class="date-input-group">
                            <input type="date" formControlName="startDate" class="form-control" required />
                            <span class="date-separator">–ø–æ</span>
                            <input type="date" formControlName="endDate" class="form-control" required />
                        </div>
                        <div class="error-message">
                            <div *ngIf="inspectionForm.get('startDate')?.hasError('required') && inspectionForm.get('startDate')?.touched">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞</div>
                            <div *ngIf="inspectionForm.get('endDate')?.hasError('required') && inspectionForm.get('endDate')?.touched">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
                            <div *ngIf="dateRangeError" class="error-message">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>–ü–ª–∞–Ω–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–µ–π)</label>
                        <input type="number" formControlName="plannedDuration" class="form-control readonly" min="1" readonly />
                    </div>

                    <div class="form-group" *ngIf="isEditMode">
                        <label>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏</label>
                        <select formControlName="status" class="form-control">
                            <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞</option>
                            <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–∞</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" (click)="onCancel()">‚úñ –û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success" [disabled]="inspectionForm.invalid || dateRangeError">üíæ {{ isEditMode ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å' }}</button>
                </div>
            </form>

            <div *ngIf="serverErrors" class="error-summary">
                <strong>–û—à–∏–±–∫–∏:</strong>
                <pre>{{ serverErrors | json }}</pre>
            </div>

            <div class="info-card">
                <h4><span>üìä</span> –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</h4>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞/–≤—ã–≥—Ä—É–∑–∫–∞ –≤ Excel –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ "–†–µ–µ—Å—Ç—Ä". –®–∞–±–ª–æ–Ω –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–æ–ª–±—Ü—ã: inspection_number, smp_id, controlling_authority, start_date, end_date, planned_duration, status, notes.</p>
            </div>
        </div>
    </div>
</div>